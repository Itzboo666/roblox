print("BGSI X25 Auto-Teleport Initializing")

-- Universal WebSocket connection function
local function connectWebSocket()
    local ws
    local maxAttempts = 3
    local attempt = 0
    
    while attempt < maxAttempts do
        local success, err = pcall(function()
            print("Connection attempt", attempt+1)
            ws = WebSocket.connect("wss://31f9-2a00-23c7-148c-9801-b5f1-956d-18b3-969e.ngrok-free.app/ws")
            
            -- Universal message handler
            ws.OnMessage = function(message)
                print("Received command:", message)
                
                -- Verify it's a teleport command
                if string.find(message, "TeleportToPlaceInstance") then
                    local execSuccess, execError = pcall(function()
                        loadstring(message)()
                    end)
                    
                    if execSuccess then
                        print("Teleport command executed!")
                        
                        -- 8-minute cooldown
                        for i = 1, 480 do  -- 480 seconds = 8 minutes
                            task.wait(1)
                            if i % 60 == 0 then
                                print((i/60).." minutes passed")
                            end
                        end
                        
                        print("Ready for new server")
                        ws:Send("READY")
                    else
                        print("Execution failed:", execError)
                    end
                end
            end
            
            -- Basic error handling
            ws.OnClose = function()
                print("Connection closed")
            end
            
            -- Initial ready signal
            ws:Send("READY")
            print("Successfully connected!")
            return ws
        end)
        
        if success then return ws end
        attempt += 1
        print("Connection failed:", err)
        task.wait(5)
    end
end

-- Main connection loop
local ws = connectWebSocket()

-- Keep-alive system
while true do
    if ws and typeof(ws) == "table" then
        -- Simple heartbeat
        pcall(function() ws:Send("PING") end)
    else
        print("Reconnecting...")
        ws = connectWebSocket()
    end
    task.wait(30)
end

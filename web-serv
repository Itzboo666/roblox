local socket = require("socket")  -- Built into Lua for Windows/LuaDist

local function connect_websocket()
    local ngrok_url = "ws://763c-2a00-23c7-148c-9801-7086-a3ca-6a40-463e.ngrok-free.app"
    local host, port = ngrok_url:match("ws://([^:/]+):?(%d*)")
    port = port or 80  -- Default WebSocket port

    local tcp = socket.tcp()
    tcp:settimeout(5)  -- 5-second timeout

    local ok, err = tcp:connect(host, port)
    if not ok then
        print("Connection failed: " .. err)
        return nil
    end

    -- Upgrade TCP to WebSocket (send handshake)
    local handshake = "GET / HTTP/1.1\r\n" ..
                      "Host: " .. host .. "\r\n" ..
                      "Upgrade: websocket\r\n" ..
                      "Connection: Upgrade\r\n" ..
                      "Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==\r\n" ..
                      "Sec-WebSocket-Version: 13\r\n\r\n"
    tcp:send(handshake)

    -- Verify response (simplified)
    local response = tcp:receive("*l")
    if not response or not response:find("101 Switching Protocols") then
        print("WebSocket handshake failed: " .. (response or "no reply"))
        tcp:close()
        return nil
    end

    print("Connected to WebSocket!")
    return tcp
end

-- Usage:
local ws = connect_websocket()
if ws then
    ws:send("Hello from Lua!")
    local reply = ws:receive("*l")  -- Read a line
    print("Server replied: " .. (reply or "nothing"))
    ws:close()
end
